name: App Store Review Analysis

on:
  # Run on schedule (every Monday at 9 AM UTC)
  schedule:
    - cron: '0 9 * * 1'

  # Run when new data is pushed to data/ folder
  push:
    paths:
      - 'data/**'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - ios_only
          - android_only

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install matplotlib numpy

      - name: Run Scrapers (Collect Latest Data)
        run: |
          echo "ðŸ”„ Collecting latest reviews..."
          python automated_pipeline.py --scrape
        continue-on-error: true

      - name: Run Analysis (CustomerInsight_Review_Agent)
        run: |
          echo "ðŸ§  Running CustomerInsight_Review_Agent analysis..."
          python automated_pipeline.py --analyze

      - name: Generate Visualizations
        run: |
          echo "ðŸ“Š Generating executive dashboards..."
          python automated_pipeline.py --visualize

      - name: Generate Summary Report
        id: report
        run: |
          echo "ðŸ“ Generating PM insights report..."
          python automated_pipeline.py --report

          # Extract key metrics for summary
          echo "report_generated=true" >> $GITHUB_OUTPUT

      - name: Commit and Push Results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add output files
          git add output/
          git add data/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-update: App Store Analysis $(date +'%Y-%m-%d')

            - Updated review data
            - Generated new insights report
            - Updated visualizations

            Co-Authored-By: CustomerInsight_Review_Agent <noreply@github.com>"
            git push
          fi

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report-${{ github.run_number }}
          path: |
            output/reports/*.md
            output/reports/*.json
            output/visualizations/*.png
          retention-days: 30

      - name: Create Summary
        run: |
          echo "## ðŸ“Š App Store Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Analysis Date: $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f output/reports/summary.json ]; then
            echo "### Key Metrics" >> $GITHUB_STEP_SUMMARY
            cat output/reports/summary.json | python -c "
import sys, json
data = json.load(sys.stdin)
print(f\"- **Total Reviews:** {data.get('total_reviews', 'N/A')}\")
print(f\"- **Average Rating:** {data.get('avg_rating', 'N/A')}\")
print(f\"- **Negative Sentiment:** {data.get('negative_pct', 'N/A')}%\")
" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
          echo "- PM Insights Report (Markdown)" >> $GITHUB_STEP_SUMMARY
          echo "- Executive Dashboard (PNG)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform Comparison Charts" >> $GITHUB_STEP_SUMMARY
