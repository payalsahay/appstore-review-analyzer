name: Friday Weekly Review Analysis

on:
  # Run every Friday at 8AM PST (4PM UTC)
  # PST = UTC-8, so 8:00 AM PST = 16:00 UTC
  schedule:
    - cron: '0 16 * * 5'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - ios_only
          - android_only
          - insights_only

jobs:
  weekly-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install matplotlib numpy

      - name: Run Weekly Friday Scraper
        id: scrape
        run: |
          echo "Starting Weekly Friday Scraper..."
          echo "Run Date: $(date +'%Y-%m-%d %H:%M %Z')"
          echo ""

          if [ "${{ github.event.inputs.run_type }}" == "insights_only" ]; then
            python scripts/weekly_friday_scraper.py --insights-only
          else
            python scripts/weekly_friday_scraper.py --all
          fi
        continue-on-error: true

      - name: Run CustomerInsight_Review_Agent Analysis
        run: |
          echo "Running CustomerInsight_Review_Agent on collected data..."

          # iOS datasets
          if [ -f "data/ios/HP_App_iOS_US_Last30Days.json" ]; then
            echo "Analyzing iOS US Last 30 Days..."
            python CustomerInsight_Review_Agent.py data/ios/HP_App_iOS_US_Last30Days.json || true
          fi

          if [ -f "data/ios/HP_App_iOS_AllCountries_Last30Days.json" ]; then
            echo "Analyzing iOS All Countries Last 30 Days..."
            python CustomerInsight_Review_Agent.py data/ios/HP_App_iOS_AllCountries_Last30Days.json || true
          fi

          if [ -f "data/ios/HP_App_iOS_US_Last500.json" ]; then
            echo "Analyzing iOS US Last 500..."
            python CustomerInsight_Review_Agent.py data/ios/HP_App_iOS_US_Last500.json || true
          fi

          # Android datasets
          if [ -f "data/googleplay/HP_App_Android_US_Last30Days.json" ]; then
            echo "Analyzing Android US Last 30 Days..."
            python CustomerInsight_Review_Agent.py data/googleplay/HP_App_Android_US_Last30Days.json || true
          fi

          if [ -f "data/googleplay/HP_App_Android_AllCountries_Last30Days.json" ]; then
            echo "Analyzing Android All Countries Last 30 Days..."
            python CustomerInsight_Review_Agent.py data/googleplay/HP_App_Android_AllCountries_Last30Days.json || true
          fi

          if [ -f "data/googleplay/HP_App_Android_US_Last500.json" ]; then
            echo "Analyzing Android US Last 500..."
            python CustomerInsight_Review_Agent.py data/googleplay/HP_App_Android_US_Last500.json || true
          fi

          # Combined datasets
          if [ -f "data/HP_App_Combined_US_Last30Days.json" ]; then
            echo "Analyzing Combined iOS + Android US Last 30 Days..."
            python CustomerInsight_Review_Agent.py data/HP_App_Combined_US_Last30Days.json || true
          fi

          if [ -f "data/HP_App_Combined_AllCountries_Last30Days.json" ]; then
            echo "Analyzing Combined iOS + Android All Countries Last 30 Days..."
            python CustomerInsight_Review_Agent.py data/HP_App_Combined_AllCountries_Last30Days.json || true
          fi

      - name: Generate Visualizations (if pipeline exists)
        run: |
          if [ -f "automated_pipeline.py" ]; then
            python automated_pipeline.py --visualize || true
          fi
        continue-on-error: true

      - name: Commit and Push Results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add all data and output files
          git add data/
          git add output/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Weekly Analysis: $(date +'%Y-%m-%d') (Friday)

          Data collected:
          - iOS US: Last 30 days rolling
          - iOS All Countries: Last 30 days rolling
          - iOS US: Last 500 reviews
          - Android US: Last 30 days rolling
          - Android All Countries: Last 30 days rolling
          - Android US: Last 500 reviews

          Analysis generated:
          - CustomerInsight reports for all datasets
          - Combined iOS + Android US (30-day rolling)
          - Combined iOS + Android All Countries (30-day rolling)

          Co-Authored-By: CustomerInsight_Review_Agent <noreply@github.com>
          Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

            git push
          fi

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weekly-analysis-${{ github.run_number }}
          path: |
            output/insights/*.md
            output/reports/*.json
            output/visualizations/*.png
            data/ios/*.json
            data/googleplay/*.json
          retention-days: 90

      - name: Create GitHub Summary
        run: |
          echo "## Friday Weekly Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Run Date: $(date +'%Y-%m-%d %H:%M %Z') (Friday 8AM PST)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Data Collected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # iOS US Last 30 Days
          if [ -f "data/ios/HP_App_iOS_US_Last30Days_Analytics.json" ]; then
            echo "#### iOS US - Last 30 Days" >> $GITHUB_STEP_SUMMARY
            cat data/ios/HP_App_iOS_US_Last30Days_Analytics.json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          print(f\"- **Total Reviews:** {data.get('total_reviews', 'N/A')}\")
          print(f\"- **Average Rating:** {data.get('avg_rating', 'N/A')}\")
          print(f\"- **1-Star:** {data.get('one_star_pct', 'N/A')}%\")
          " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # iOS All Countries Last 30 Days
          if [ -f "data/ios/HP_App_iOS_AllCountries_Last30Days_Analytics.json" ]; then
            echo "#### iOS All Countries - Last 30 Days" >> $GITHUB_STEP_SUMMARY
            cat data/ios/HP_App_iOS_AllCountries_Last30Days_Analytics.json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          print(f\"- **Total Reviews:** {data.get('total_reviews', 'N/A')}\")
          print(f\"- **Average Rating:** {data.get('avg_rating', 'N/A')}\")
          " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # iOS US Last 500
          if [ -f "data/ios/HP_App_iOS_US_Last500_Analytics.json" ]; then
            echo "#### iOS US - Last 500" >> $GITHUB_STEP_SUMMARY
            cat data/ios/HP_App_iOS_US_Last500_Analytics.json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          print(f\"- **Total Reviews:** {data.get('total_reviews', 'N/A')}\")
          print(f\"- **Average Rating:** {data.get('avg_rating', 'N/A')}\")
          " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Android US Last 30 Days
          if [ -f "data/googleplay/HP_App_Android_US_Last30Days_Analytics.json" ]; then
            echo "#### Android US - Last 30 Days" >> $GITHUB_STEP_SUMMARY
            cat data/googleplay/HP_App_Android_US_Last30Days_Analytics.json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          print(f\"- **Total Reviews:** {data.get('total_reviews', 'N/A')}\")
          print(f\"- **Average Rating:** {data.get('avg_rating', 'N/A')}\")
          print(f\"- **1-Star:** {data.get('one_star_pct', 'N/A')}%\")
          " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Android All Countries Last 30 Days
          if [ -f "data/googleplay/HP_App_Android_AllCountries_Last30Days_Analytics.json" ]; then
            echo "#### Android All Countries - Last 30 Days" >> $GITHUB_STEP_SUMMARY
            cat data/googleplay/HP_App_Android_AllCountries_Last30Days_Analytics.json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          print(f\"- **Total Reviews:** {data.get('total_reviews', 'N/A')}\")
          print(f\"- **Average Rating:** {data.get('avg_rating', 'N/A')}\")
          " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Android US Last 500
          if [ -f "data/googleplay/HP_App_Android_US_Last500_Analytics.json" ]; then
            echo "#### Android US - Last 500" >> $GITHUB_STEP_SUMMARY
            cat data/googleplay/HP_App_Android_US_Last500_Analytics.json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          print(f\"- **Total Reviews:** {data.get('total_reviews', 'N/A')}\")
          print(f\"- **Average Rating:** {data.get('avg_rating', 'N/A')}\")
          " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
          echo "#### iOS" >> $GITHUB_STEP_SUMMARY
          echo "- iOS US Last 30 Days Insights Report" >> $GITHUB_STEP_SUMMARY
          echo "- iOS All Countries Last 30 Days Insights Report" >> $GITHUB_STEP_SUMMARY
          echo "- iOS US Last 500 Insights Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Android" >> $GITHUB_STEP_SUMMARY
          echo "- Android US Last 30 Days Insights Report" >> $GITHUB_STEP_SUMMARY
          echo "- Android All Countries Last 30 Days Insights Report" >> $GITHUB_STEP_SUMMARY
          echo "- Android US Last 500 Insights Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Combined" >> $GITHUB_STEP_SUMMARY
          echo "- Combined iOS + Android US (30-day rolling)" >> $GITHUB_STEP_SUMMARY
          echo "- Combined iOS + Android All Countries (30-day rolling)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated by Weekly Friday Scraper + CustomerInsight_Review_Agent*" >> $GITHUB_STEP_SUMMARY
